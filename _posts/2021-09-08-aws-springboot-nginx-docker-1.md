---
title: AWS, SpringBoot, Nginx, Docker로 무중단 배포하기(1)
categories:
- Project
---

AWS 프리티어 계정으로 EC2 t2.micro 서버를 생성하고, 이 서버에 SpringBoot 기반의 App Server를 구동하고 Nginx와 Docker로 무중단 배포하는 과정을 써보도록 하겠습니다.

먼저, 사용되는 도구 및 기술은 다음과 같습니다.

1. 서버 인프라 : AWS EC2
2. 어플리케이션 환경 : 자바11, 스프링부트  2.5.1
3. 포트 라우팅 : Nginx
4. 배포 환경 : Git Action, AWS S3, AWS CodeDeploy, Docker


![Deploy](https://user-images.githubusercontent.com/72685070/132517742-98054b43-dee5-4b3c-9751-ad5612d9a5c5.png)


간략하게 프로세스를 정리해보면 다음과 같습니다.

1. 로컬서버에서 개발을 하고 소스코드를 Git으로 업로드 합니다.
2. GIt Action을 통해서 프로젝트를 빌드하여 생성된 jar파일을 S3에 업로드 합니다.
3. CodeDeploy는 EC2에 있는 Agent에게 배포 명령을 내리면, Agent는 연동된 S3의 jar를 로드합니다.
4. Docker 명령에 따라 Docker 빌드를 하고, Nginx 포트 스위칭을 하여 운영


## AWS EC2 서버 설정


AWS EC2 서버는 Ubuntu 20.04로 하였으며, 용량은 최대 크기인 30gb로 하였습니다. 
스프링부트환경에서 application.yml 설정을 통해 개발과 운영환경에 따른 binding-port를 지정할 수 있습니다.


## SpringBoot - application.yml 설정

<div class="colorscripter-code" style="color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important;overflow:auto"><table class="colorscripter-code-table" style="margin:0;padding:0;border:none;background-color:#fafafa;border-radius:4px;" cellspacing="0" cellpadding="0"><tr><td style="padding:6px;border-right:2px solid #e5e5e5"><div style="margin:0;padding:0;word-break:normal;text-align:right;color:#666;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div><div style="line-height:130%">4</div><div style="line-height:130%">5</div><div style="line-height:130%">6</div><div style="line-height:130%">7</div><div style="line-height:130%">8</div><div style="line-height:130%">9</div><div style="line-height:130%">10</div><div style="line-height:130%">11</div><div style="line-height:130%">12</div><div style="line-height:130%">13</div><div style="line-height:130%">14</div><div style="line-height:130%">15</div><div style="line-height:130%">16</div><div style="line-height:130%">17</div><div style="line-height:130%">18</div><div style="line-height:130%">19</div><div style="line-height:130%">20</div><div style="line-height:130%">21</div><div style="line-height:130%">22</div><div style="line-height:130%">23</div><div style="line-height:130%">24</div></div></td><td style="padding:6px 0;text-align:left"><div style="margin:0;padding:0;color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%">spring:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;profiles:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;group:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#63a35c">"dev"</span>:&nbsp;<span style="color:#63a35c">"dev_port"</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">spring:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;config:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;activate:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on<span style="color:#0086b3"></span><span style="color:#a71d5d">-</span>profile:&nbsp;<span style="color:#63a35c">"dev_port"</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">server:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;port:&nbsp;<span style="color:#0099cc">8081</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">spring:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;profiles:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;group:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#63a35c">"prod"</span>:&nbsp;<span style="color:#63a35c">"prod_port"</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span><span style="color:#0086b3"></span><span style="color:#a71d5d">-</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">spring:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;config:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;activate:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on<span style="color:#0086b3"></span><span style="color:#a71d5d">-</span>profile:&nbsp;<span style="color:#63a35c">"prod_port"</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">server:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;port:&nbsp;<span style="color:#0099cc">8082</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div></div></td><td style="vertical-align:bottom;padding:0 2px 4px 0"><a href="http://colorscripter.com/info#e" target="_blank" style="text-decoration:none;color:white"><span style="font-size:9px;word-break:normal;background-color:#e5e5e5;color:white;border-radius:10px;padding:1px">cs</span></a></td></tr></table></div>


위에서 보는 바와 같이 프로파일 구분자(---)로 여러 환경의 설정정보를 저장할 수 있습니다. jar파일을 구동할 때 profiles.active를 어떻게 지정하냐에 따라 다른 포트로 구동됩니다.


## Nginx 설정

Nginx는 3가지 기능을 합니다.
1. 웹서버의 기능
2. SSL 인증서 적용(let's encrypt 적용)
3. 서비스로 포트 라우팅(proxy pass)

nginx config 설정은 다음과 같이 하였습니다. (/etc/nginx/sites-available/default)

<div class="colorscripter-code" style="color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important;overflow:auto"><table class="colorscripter-code-table" style="margin:0;padding:0;border:none;background-color:#fafafa;border-radius:4px;" cellspacing="0" cellpadding="0"><tr><td style="padding:6px;border-right:2px solid #e5e5e5"><div style="margin:0;padding:0;word-break:normal;text-align:right;color:#666;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div><div style="line-height:130%">4</div><div style="line-height:130%">5</div><div style="line-height:130%">6</div><div style="line-height:130%">7</div><div style="line-height:130%">8</div><div style="line-height:130%">9</div><div style="line-height:130%">10</div><div style="line-height:130%">11</div><div style="line-height:130%">12</div><div style="line-height:130%">13</div><div style="line-height:130%">14</div><div style="line-height:130%">15</div><div style="line-height:130%">16</div><div style="line-height:130%">17</div><div style="line-height:130%">18</div><div style="line-height:130%">19</div><div style="line-height:130%">20</div><div style="line-height:130%">21</div><div style="line-height:130%">22</div><div style="line-height:130%">23</div><div style="line-height:130%">24</div><div style="line-height:130%">25</div><div style="line-height:130%">26</div><div style="line-height:130%">27</div><div style="line-height:130%">28</div><div style="line-height:130%">29</div><div style="line-height:130%">30</div><div style="line-height:130%">31</div><div style="line-height:130%">32</div><div style="line-height:130%">33</div><div style="line-height:130%">34</div><div style="line-height:130%">35</div><div style="line-height:130%">36</div><div style="line-height:130%">37</div><div style="line-height:130%">38</div><div style="line-height:130%">39</div><div style="line-height:130%">40</div></div></td><td style="padding:6px 0;text-align:left"><div style="margin:0;padding:0;color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%">server&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;<span style="color:#308ce5">80</span>;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>var<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>www<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>html;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#999999">#&nbsp;Add&nbsp;index.php&nbsp;to&nbsp;the&nbsp;list&nbsp;if&nbsp;you&nbsp;are&nbsp;using&nbsp;PHP</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.nginx<span style="color:#0086b3"></span><span style="color:#ff3399">-</span>debian.html;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>nginx<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>conf.d<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>service_url.inc;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff3399">return</span>&nbsp;<span style="color:#308ce5">301</span>&nbsp;https:<span style="color:#0086b3"></span><span style="color:#ff3399">/</span><span style="color:#0086b3"></span><span style="color:#ff3399">/</span>$host$request_uri;</div><div style="padding:0 6px; white-space:pre; line-height:130%">}</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">server&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>var<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>www<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>html;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#999999">#&nbsp;Add&nbsp;index.php&nbsp;to&nbsp;the&nbsp;list&nbsp;if&nbsp;you&nbsp;are&nbsp;using&nbsp;PHP</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;index.html&nbsp;index.htm&nbsp;index.nginx<span style="color:#0086b3"></span><span style="color:#ff3399">-</span>debian.html;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>nginx<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>conf.d<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>service_url.inc;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_ssl_server_name&nbsp;on;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_pass&nbsp;$service_url;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;HOST&nbsp;$host;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#999999">#listen&nbsp;[::]:443&nbsp;ssl&nbsp;ipv6only=on;&nbsp;#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;<span style="color:#308ce5">443</span>&nbsp;ssl;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;ssl_certificate&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>letsencrypt<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>live<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>&nbsp;&nbsp;&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>fullchain.pem;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;ssl_certificate_key&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>letsencrypt<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>live<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>&nbsp;&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>privkey.pem;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>letsencrypt<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>options<span style="color:#0086b3"></span><span style="color:#ff3399">-</span>ssl<span style="color:#0086b3"></span><span style="color:#ff3399">-</span>nginx.conf;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;ssl_dhparam&nbsp;<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>etc<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>letsencrypt<span style="color:#0086b3"></span><span style="color:#ff3399">/</span>ssl<span style="color:#0086b3"></span><span style="color:#ff3399">-</span>dhparams.pem;&nbsp;<span style="color:#999999">#&nbsp;managed&nbsp;by&nbsp;Certbot</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">}</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div></div><div style="text-align:right;margin-top:-13px;margin-right:5px;font-size:9px;font-style:italic"><a href="http://colorscripter.com/info#e" target="_blank" style="color:#e5e5e5text-decoration:none">Colored by Color Scripter</a></div></td><td style="vertical-align:bottom;padding:0 2px 4px 0"><a href="http://colorscripter.com/info#e" target="_blank" style="text-decoration:none;color:white"><span style="font-size:9px;word-break:normal;background-color:#e5e5e5;color:white;border-radius:10px;padding:1px">cs</span></a></td></tr></table></div>

<br>
-. 다음과 같은 명령어로 nginx에 let's encrypt를 적용한다.

	$ wget https://dl.eff.org/certbot-auto 
	$ chmod a+x certbot-auto

-. https가 아닌 http 요청은 HTTP 301코드를 리턴한다.

-. $service_url http://127.0.0.1:8081; 로 설정하여 8081 포트로 포워딩한다.
